<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Registration Form</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='addstudent.css') }}"
    />

    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.7.0/css/all.css"
      integrity="sha384-1ZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9s+oqd12jhcu+A56Ebc1zFSJ"
      crossorigin="anonymous"
    />
    <script src="./addstudent.js" type="text/javascript"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>

  <body>
    <div class="wrapper">
      <div class="title">Student Registration Form</div>
      <form
        method="POST"
        id="registrationForm"
        data-netlify="true"
        action="/submit"
        enctype="multipart/form-data"
      >
        <div class="form">
          <div class="inputfield">
            <label>First Name</label>
            <input
              type="text"
              class="input"
              id="name"
              name="fname"
              placeholder="Enter first name"
              maxlength="30"
              pattern="[A-Za-z]{1,32}"
              title="Enter only alphabets"
              required
            />
          </div>

          <div class="inputfield">
            <label>Last Name</label>
            <input
              type="text"
              class="input"
              id="name"
              name="lname"
              placeholder="Enter last name"
              maxlength="30"
              pattern="[A-Za-z]{1,32}"
              title="Enter only alphabets"
              required
            />
          </div>

          <div class="inputfield" id="gender">
            <label for="">Gender</label>
            <input type="radio" name="gender" id="radio" value="Male" />Male
            <input type="radio" name="gender" id="radio" value="Female" />Female
          </div>

          <div class="inputfield">
            <label for="">Date of Birth</label>
            <input type="date" class="input" name="dob" required />
          </div>

          <div class="inputfield">
            <label>Email Address</label>
            <input
              type="email"
              class="input"
              name="email"
              placeholder="Enter your email"
              pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,63}$"
              required
            />
          </div>

          <p id="message"></p>

          <div class="inputfield">
            <label for="">Phone Number</label>
            <div class="custom-select" id="phone-codes">
              <select id="phone-code">
                <option value="+91">+91</option>
              </select>
            </div>
            <input
              type="tel"
              class="input"
              name="phone_number"
              maxlength="10"
              id="phone-number"
              placeholder="Enter your phone number"
              pattern="[7-9]{1}[0-9]{9}"
              title="Please enter valid phone number"
            />
          </div>

          <div class="inputfield">
            <label for="">Registration Number</label>
            <input
              type="Registration Number"
              class="input"
              name="register"
              maxlength="10"
              id="register"
              placeholder="Enter Registration Number"
              pattern="[0-9]*"
              title="Please enter only Numbers"
            />
          </div>

          <div class="inputfield">
            <label>Address</label>
            <textarea
              class="textarea"
              name="address"
              id=""
              cols="30"
              rows="5"
              placeholder="Enter your address"
              pattern="^[a-zA-Z][a-zA-Z0-9-_.]{5,12}$"
              maxlength="100"
              required
            ></textarea>
          </div>

          <div class="inputfield">
            <label>State</label>
            <div class="custom_select">
              <select id="state" name="state" required>
                <option value="">--Select your state--</option>
                <option value="Andaman and Nicobar Islands">
                  Andaman and Nicobar Islands
                </option>
                <option value="Andhra Pradesh">Andhra Pradesh</option>
                <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                <option value="Assam">Assam</option>
                <option value="Bihar">Bihar</option>
                <option value="Chandigarh">Chandigarh</option>
                <option value="Chhattisgarh">Chhattisgarh</option>
                <option value="Dadra and Nagar Haveli">
                  Dadra and Nagar Haveli
                </option>
                <option value="Daman and Diu">Daman and Diu</option>
                <option value="Delhi">Delhi</option>
                <option value="Goa">Goa</option>
                <option value="Gujarat">Gujarat</option>
                <option value="Haryana">Haryana</option>
                <option value="Himachal Pradesh">Himachal Pradesh</option>
                <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                <option value="Jharkhand">Jharkhand</option>
                <option value="Karnataka">Karnataka</option>
                <option value="Kerala">Kerala</option>
                <option value="Ladakh">Ladakh</option>
                <option value="Lakshadweep">Lakshadweep</option>
                <option value="Madhya Pradesh">Madhya Pradesh</option>
                <option value="Maharashtra">Maharashtra</option>
                <option value="Manipur">Manipur</option>
                <option value="Meghalaya">Meghalaya</option>
                <option value="Mizoram">Mizoram</option>
                <option value="Nagaland">Nagaland</option>
                <option value="Odisha">Odisha</option>
                <option value="Puducherry">Puducherry</option>
                <option value="Punjab">Punjab</option>
                <option value="Rajasthan">Rajasthan</option>
                <option value="Sikkim">Sikkim</option>
                <option value="Tamil Nadu">Tamil Nadu</option>
                <option value="Telangana">Telangana</option>
                <option value="Tripura">Tripura</option>
                <option value="Uttar Pradesh">Uttar Pradesh</option>
                <option value="Uttarakhand">Uttarakhand</option>
                <option value="West Bengal">West Bengal</option>
              </select>
            </div>
          </div>

          <div class="inputfield">
            <label>Pin Code</label>
            <input
              type="text"
              class="input"
              name="pincode"
              placeholder="Enter your pin code"
              maxlength="6"
              pattern="^[0-9]{6}$"
              required
            />
          </div>

          <div class="inputfield">
            <label>Take Photo</label>
            <button onclick="startCamera()" type="button">Start Camera</button>
            <button onclick="captureImage()" type="button" name="photo">
              Capture Photo
            </button>
            <p id="camera-error" style="color: red; display: none">
              Error accessing camera.
            </p>
            <div id="camera-preview" style="display: none; margin-top: 10px">
              <video
                id="video"
                width="320"
                height="240"
                style="display: block"
              ></video>
            </div>
            <canvas
              id="canvas"
              width="320"
              height="240"
              style="display: none"
            ></canvas>
            <img
              id="captured-photo"
              style="display: none; width: 320px; height: 240px"
            />
          </div>

          <div class="inputfield terms">
            <label class="check">
              <input type="checkbox" name="check" value="Declared" required />
              <span class="checkmark"></span>
            </label>
            <p>
              I hereby declare that the above information provided is true and
              correct.
            </p>
          </div>

          <div class="inputfield" required>
            <div data-netlify-recaptcha="true"></div>
          </div>

          <div class="inputfield btns" id="btn">
            <button
              type="submit"
              value="Register"
              class="btn"
              onclick="checkPassword()"
            >
              Register
            </button>
            <a
              href="/dashboard"
              value="return"
              class="btn"
              style="text-align: center"
              >Go Back</a
            >
          </div>
        </div>
      </form>
      <script>
        let stream;

        async function startCamera() {
          try {
            const previewDiv = document.getElementById("camera-preview");
            previewDiv.style.display = "block";
            const capturedPhoto = document.getElementById("captured-photo");
            capturedPhoto.style.display = "none"; // Hide captured photo if it's visible

            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            const video = document.getElementById("video");
            video.srcObject = stream;
            video.play();
          } catch (err) {
            console.error("Error accessing camera:", err);
            const errorElement = document.getElementById("camera-error");
            errorElement.style.display = "block";
          }
        }

        function captureImage() {
          if (stream) {
            const video = document.getElementById("video");
            const canvas = document.getElementById("canvas");
            const context = canvas.getContext("2d");

            canvas.width = 320; // Set canvas width to 320px
            canvas.height = 240; // Set canvas height to 240px
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Convert canvas data to base64-encoded JPEG image
            const dataURL = canvas.toDataURL("image/jpeg");

            // Get the registration number from the form
            const register = document.getElementById("register").value;

            // Send image data and registration number to the server
            fetch("/saveImage", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ image: dataURL, register: register }),
            })
              .then((response) => {
                if (response.ok) {
                  console.log("Image saved successfully");
                } else {
                  console.error("Failed to save image");
                }
              })
              .catch((error) => {
                console.error("Error:", error);
              });

            const img = document.getElementById("captured-photo");
            img.src = dataURL;
            img.style.display = "block";
            img.width = 320; // Set width to 320px
            img.height = 240; // Set height to 240px

            const previewDiv = document.getElementById("camera-preview");
            previewDiv.style.display = "none"; // Hide camera preview

            $(document).ready(function () {
              // Function to handle form submission
              $("form").submit(function (event) {
                event.preventDefault(); // Prevent the default form submission behavior
                var formData = $(this).serialize(); // Serialize form data

                // Send form data to the server via AJAX
                $.ajax({
                  type: "POST",
                  url: "/add_student",
                  data: formData,
                  success: function (response) {
                    // Redirect to studentdetails.html with form data
                    var firstName = $("input[name='fname']").val();
                    var lastName = $("input[name='lname']").val();
                    var registrationNumber = $("input[name='register']").val();
                    var url =
                      "/studentdetails.html?firstName=" +
                      encodeURIComponent(firstName) +
                      "&lastName=" +
                      encodeURIComponent(lastName) +
                      "&registrationNumber=" +
                      encodeURIComponent(registrationNumber);
                    window.location.href = url;
                  },
                  error: function (xhr, status, error) {
                    console.error(error);
                  },
                });
              });
            });
          }
        }

        $(document).ready(function () {
          // Function to handle form submission for adding a student
          $("#registrationForm").submit(function (event) {
            event.preventDefault(); // Prevent the default form submission behavior
            var formData = new FormData(this); // Capture form data

            // Send form data to the server via AJAX
            $.ajax({
              type: "POST",
              url: "/submit", // Ensure this matches your Flask endpoint for adding a student
              data: formData,
              processData: false,
              contentType: false,
              success: function (response) {
                // Handle success response
                console.log("Registration successful");
                alert("Student registered successfully");
                window.location.href = "/dashboard"; // Redirect to the dashboard
              },
              error: function (xhr, status, error) {
                // Handle error response
                console.error("Registration failed:", error);
                // Optionally, display an error message to the user
              },
            });
          });
        });
      </script>
    </div>
  </body>
</html>
